<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Cervantes (fernando.cervantes@jax.org)">

<title>Advanced Machine Learning with Python – Advanced Machine Learning with Python workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Advanced Machine Learning with Python workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Adv_ML_Python.html"> 
<span class="menu-text">Session 1/2</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#workshop-outcomes" id="toc-workshop-outcomes" class="nav-link active" data-scroll-target="#workshop-outcomes">Workshop outcomes</a></li>
  <li><a href="#setup-environment" id="toc-setup-environment" class="nav-link" data-scroll-target="#setup-environment">0. Setup environment</a>
  <ul class="collapse">
  <li><a href="#select-runtime-and-connect" id="toc-select-runtime-and-connect" class="nav-link" data-scroll-target="#select-runtime-and-connect">Select runtime and connect</a></li>
  </ul></li>
  <li><a href="#what-is-machine-learning-ml" id="toc-what-is-machine-learning-ml" class="nav-link" data-scroll-target="#what-is-machine-learning-ml">1. What is <strong>M</strong>achine <strong>L</strong>earning (<strong>ML</strong>)?</a>
  <ul class="collapse">
  <li><a href="#machine-learning-ml" id="toc-machine-learning-ml" class="nav-link" data-scroll-target="#machine-learning-ml"><strong>M</strong>achine <strong>L</strong>earning (<strong>ML</strong>)</a></li>
  <li><a href="#artificial-intelligence-tasks" id="toc-artificial-intelligence-tasks" class="nav-link" data-scroll-target="#artificial-intelligence-tasks">Artificial intelligence tasks</a></li>
  <li><a href="#common-tasks" id="toc-common-tasks" class="nav-link" data-scroll-target="#common-tasks">Common tasks</a>
  <ul class="collapse">
  <li><a href="#more-tasks-addressed-in-recent-years" id="toc-more-tasks-addressed-in-recent-years" class="nav-link" data-scroll-target="#more-tasks-addressed-in-recent-years">More tasks addressed in recent years</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#types-of-machine-learning" id="toc-types-of-machine-learning" class="nav-link" data-scroll-target="#types-of-machine-learning">Types of machine learning</a>
  <ul class="collapse">
  <li><a href="#types-of-machine-learning-1" id="toc-types-of-machine-learning-1" class="nav-link" data-scroll-target="#types-of-machine-learning-1">Types of machine learning</a>
  <ul class="collapse">
  <li><a href="#depending-on-how-the-model-is-trained" id="toc-depending-on-how-the-model-is-trained" class="nav-link" data-scroll-target="#depending-on-how-the-model-is-trained">Depending on how the model is trained</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#inputs-and-outputs" id="toc-inputs-and-outputs" class="nav-link" data-scroll-target="#inputs-and-outputs">Inputs and outputs</a>
  <ul class="collapse">
  <li><a href="#inputs-and-outputs-1" id="toc-inputs-and-outputs-1" class="nav-link" data-scroll-target="#inputs-and-outputs-1">Inputs and outputs</a></li>
  <li><a href="#use-case-image-classification-with-the-cifar-100-dataset" id="toc-use-case-image-classification-with-the-cifar-100-dataset" class="nav-link" data-scroll-target="#use-case-image-classification-with-the-cifar-100-dataset">Use case: Image classification with the CIFAR-100 dataset</a></li>
  </ul></li>
  <li><a href="#introduction-to-pytorch" id="toc-introduction-to-pytorch" class="nav-link" data-scroll-target="#introduction-to-pytorch">Introduction to PyTorch</a>
  <ul class="collapse">
  <li><a href="#what-is-a-tensor-pytorch" id="toc-what-is-a-tensor-pytorch" class="nav-link" data-scroll-target="#what-is-a-tensor-pytorch">What is a tensor (PyTorch)?</a></li>
  <li><a href="#exercise-add-the-preprocessing-pipeline-to-the-cifar-100-dataset" id="toc-exercise-add-the-preprocessing-pipeline-to-the-cifar-100-dataset" class="nav-link" data-scroll-target="#exercise-add-the-preprocessing-pipeline-to-the-cifar-100-dataset">Exercise: Add the preprocessing pipeline to the CIFAR-100 dataset</a></li>
  </ul></li>
  <li><a href="#training-validation-and-test-data" id="toc-training-validation-and-test-data" class="nav-link" data-scroll-target="#training-validation-and-test-data">Training, Validation, and Test data</a>
  <ul class="collapse">
  <li><a href="#training-set" id="toc-training-set" class="nav-link" data-scroll-target="#training-set">Training set</a></li>
  <li><a href="#validation-set" id="toc-validation-set" class="nav-link" data-scroll-target="#validation-set">Validation set</a></li>
  <li><a href="#test-set" id="toc-test-set" class="nav-link" data-scroll-target="#test-set">Test set</a></li>
  <li><a href="#exercise-load-the-test-set-and-split-the-train-set-into-train-and-validation-subsets" id="toc-exercise-load-the-test-set-and-split-the-train-set-into-train-and-validation-subsets" class="nav-link" data-scroll-target="#exercise-load-the-test-set-and-split-the-train-set-into-train-and-validation-subsets">Exercise: Load the test set and split the train set into train and validation subsets</a></li>
  </ul></li>
  <li><a href="#deep-learning-dl-models" id="toc-deep-learning-dl-models" class="nav-link" data-scroll-target="#deep-learning-dl-models"><strong>D</strong>eep <strong>L</strong>earning (<strong>DL</strong>) models</a>
  <ul class="collapse">
  <li><a href="#deep-learning-dl-models-1" id="toc-deep-learning-dl-models-1" class="nav-link" data-scroll-target="#deep-learning-dl-models-1">Deep Learning (DL) models</a></li>
  <li><a href="#exercise-create-a-logisic-regression-model-with-pytorch" id="toc-exercise-create-a-logisic-regression-model-with-pytorch" class="nav-link" data-scroll-target="#exercise-create-a-logisic-regression-model-with-pytorch">Exercise: Create a Logisic Regression model with PyTorch</a></li>
  <li><a href="#exercise-create-a-multilayer-perceptron-mlp-model-with-pytorch" id="toc-exercise-create-a-multilayer-perceptron-mlp-model-with-pytorch" class="nav-link" data-scroll-target="#exercise-create-a-multilayer-perceptron-mlp-model-with-pytorch">Exercise: Create a MultiLayer Perceptron (MLP) model with PyTorch</a></li>
  </ul></li>
  <li><a href="#model-optimization" id="toc-model-optimization" class="nav-link" data-scroll-target="#model-optimization">Model optimization</a>
  <ul class="collapse">
  <li><a href="#model-fittingtraining" id="toc-model-fittingtraining" class="nav-link" data-scroll-target="#model-fittingtraining">Model fitting/training</a></li>
  </ul></li>
  <li><a href="#loss-function" id="toc-loss-function" class="nav-link" data-scroll-target="#loss-function">Loss function</a>
  <ul class="collapse">
  <li><a href="#loss-function-1" id="toc-loss-function-1" class="nav-link" data-scroll-target="#loss-function-1">Loss function</a></li>
  <li><a href="#loss-function-for-regression" id="toc-loss-function-for-regression" class="nav-link" data-scroll-target="#loss-function-for-regression">11.1 Loss function for regression</a></li>
  <li><a href="#loss-function-for-classification" id="toc-loss-function-for-classification" class="nav-link" data-scroll-target="#loss-function-for-classification">Loss function for classification</a></li>
  <li><a href="#exercise-define-the-loss-function-for-the-cifar-100-classification-problem" id="toc-exercise-define-the-loss-function-for-the-cifar-100-classification-problem" class="nav-link" data-scroll-target="#exercise-define-the-loss-function-for-the-cifar-100-classification-problem">Exercise: Define the loss function for the CIFAR-100 classification problem</a></li>
  <li><a href="#exercise-define-the-loss-function-for-the-cifar-100-classification-problem-1" id="toc-exercise-define-the-loss-function-for-the-cifar-100-classification-problem-1" class="nav-link" data-scroll-target="#exercise-define-the-loss-function-for-the-cifar-100-classification-problem-1">Exercise: Define the loss function for the CIFAR-100 classification problem</a></li>
  </ul></li>
  <li><a href="#gradient-based-optimization" id="toc-gradient-based-optimization" class="nav-link" data-scroll-target="#gradient-based-optimization">Gradient based optimization</a>
  <ul class="collapse">
  <li><a href="#gradient-based-optimization-1" id="toc-gradient-based-optimization-1" class="nav-link" data-scroll-target="#gradient-based-optimization-1">Gradient based optimization</a>
  <ul class="collapse">
  <li><a href="#gradient-descent" id="toc-gradient-descent" class="nav-link" data-scroll-target="#gradient-descent"><strong>Gradient Descent</strong></a></li>
  </ul></li>
  <li><a href="#exercise-compute-the-gradient-of-the-loss-function-with-respect-to-the-parameters-of-the-mlp." id="toc-exercise-compute-the-gradient-of-the-loss-function-with-respect-to-the-parameters-of-the-mlp." class="nav-link" data-scroll-target="#exercise-compute-the-gradient-of-the-loss-function-with-respect-to-the-parameters-of-the-mlp.">Exercise: Compute the gradient of the loss function with respect to the parameters of the MLP.</a></li>
  <li><a href="#stochastic-methods" id="toc-stochastic-methods" class="nav-link" data-scroll-target="#stochastic-methods">Stochastic methods</a></li>
  <li><a href="#stochastic-gradient-descent-sgd" id="toc-stochastic-gradient-descent-sgd" class="nav-link" data-scroll-target="#stochastic-gradient-descent-sgd"><strong>S</strong>tochastic <strong>G</strong>radient <strong>D</strong>escent (<strong>SGD</strong>)</a></li>
  <li><a href="#training-with-mini-batches" id="toc-training-with-mini-batches" class="nav-link" data-scroll-target="#training-with-mini-batches">Training with mini-batches</a></li>
  <li><a href="#exercise-train-the-mlp-classifier" id="toc-exercise-train-the-mlp-classifier" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier">Exercise: Train the MLP classifier</a></li>
  <li><a href="#exercise-train-the-mlp-classifier-1" id="toc-exercise-train-the-mlp-classifier-1" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier-1">Exercise: Train the MLP classifier</a></li>
  <li><a href="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss" id="toc-exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss">Exercise: Train the MLP classifier and track the training and validation loss</a></li>
  <li><a href="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-1" id="toc-exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-1" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-1">Exercise: Train the MLP classifier and track the training and validation loss</a></li>
  <li><a href="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-2" id="toc-exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-2" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-2">Exercise: Train the MLP classifier and track the training and validation loss</a></li>
  <li><a href="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-through-several-epochs" id="toc-exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-through-several-epochs" class="nav-link" data-scroll-target="#exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-through-several-epochs">Exercise: Train the MLP classifier and track the training and validation loss through several <em>epochs</em></a></li>
  <li><a href="#exercise-show-the-progress-of-the-training-throught-the-epochs" id="toc-exercise-show-the-progress-of-the-training-throught-the-epochs" class="nav-link" data-scroll-target="#exercise-show-the-progress-of-the-training-throught-the-epochs">Exercise: Show the progress of the training throught the epochs</a></li>
  </ul></li>
  <li><a href="#performance-metrics" id="toc-performance-metrics" class="nav-link" data-scroll-target="#performance-metrics">Performance metrics</a>
  <ul class="collapse">
  <li><a href="#performance-metrics-1" id="toc-performance-metrics-1" class="nav-link" data-scroll-target="#performance-metrics-1">Performance metrics</a></li>
  <li><a href="#exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100" id="toc-exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100" class="nav-link" data-scroll-target="#exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100">Exercise: Measure the accuracy of the MLP trained to classify images from CIFAR-100</a></li>
  <li><a href="#exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100-1" id="toc-exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100-1" class="nav-link" data-scroll-target="#exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100-1">Exercise: Measure the accuracy of the MLP trained to classify images from CIFAR-100</a></li>
  </ul></li>
  <li><a href="#convolutional-neural-network-cnn-or-convnet" id="toc-convolutional-neural-network-cnn-or-convnet" class="nav-link" data-scroll-target="#convolutional-neural-network-cnn-or-convnet"><strong>C</strong>onvolutional <strong>N</strong>eural <strong>N</strong>etwork (<strong>CNN</strong> or <strong>ConvNet</strong>)</a>
  <ul class="collapse">
  <li><a href="#convolution-layers" id="toc-convolution-layers" class="nav-link" data-scroll-target="#convolution-layers">Convolution layers</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation" id="toc-exercise-visualize-the-effect-of-the-convolution-operation" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-1" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-1" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-1">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-2" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-2" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-2">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-3" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-3" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-3">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-4" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-4" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-4">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-5" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-5" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-5">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#exercise-visualize-the-effect-of-the-convolution-operation-6" id="toc-exercise-visualize-the-effect-of-the-convolution-operation-6" class="nav-link" data-scroll-target="#exercise-visualize-the-effect-of-the-convolution-operation-6">Exercise: Visualize the effect of the convolution operation</a></li>
  <li><a href="#examples-of-popular-deep-learning-models-in-computer-vision" id="toc-examples-of-popular-deep-learning-models-in-computer-vision" class="nav-link" data-scroll-target="#examples-of-popular-deep-learning-models-in-computer-vision">Examples of popular Deep Learning models in computer vision</a></li>
  <li><a href="#examples-of-popular-deep-learning-models-in-computer-vision-1" id="toc-examples-of-popular-deep-learning-models-in-computer-vision-1" class="nav-link" data-scroll-target="#examples-of-popular-deep-learning-models-in-computer-vision-1">Examples of popular Deep Learning models in computer vision</a></li>
  <li><a href="#examples-of-popular-deep-learning-models-in-computer-vision-2" id="toc-examples-of-popular-deep-learning-models-in-computer-vision-2" class="nav-link" data-scroll-target="#examples-of-popular-deep-learning-models-in-computer-vision-2">Examples of popular Deep Learning models in computer vision</a></li>
  <li><a href="#exercise-implement-letnet-5-in-pytorch" id="toc-exercise-implement-letnet-5-in-pytorch" class="nav-link" data-scroll-target="#exercise-implement-letnet-5-in-pytorch">Exercise: Implement LetNet-5 in PyTorch</a></li>
  <li><a href="#exercise-implement-letnet-5-in-pytorch-1" id="toc-exercise-implement-letnet-5-in-pytorch-1" class="nav-link" data-scroll-target="#exercise-implement-letnet-5-in-pytorch-1">Exercise: Implement LetNet-5 in PyTorch</a></li>
  <li><a href="#exercise-implement-letnet-5-in-pytorch-2" id="toc-exercise-implement-letnet-5-in-pytorch-2" class="nav-link" data-scroll-target="#exercise-implement-letnet-5-in-pytorch-2">Exercise: Implement LetNet-5 in PyTorch</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Adv_ML_Python_presentation.html"><i class="bi bi-file-slides"></i>RevealJS</a></li><li><a href="Adv_ML_Python.ipynb" download="Adv_ML_Python.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Advanced Machine Learning with Python</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Cervantes (fernando.cervantes@jax.org) </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="workshop-outcomes" class="level1">
<h1>Workshop outcomes</h1>
<ul>
<li>Understand the process of training ML models.</li>
<li>Load pre-trained ML models and fine-tune them with new data.</li>
<li>Evaluate the performance of ML models.</li>
<li>Adapt ML models for different tasks from pre-trained models.</li>
</ul>
</section>
<section id="setup-environment" class="level1">
<h1>0. Setup environment</h1>
<section id="select-runtime-and-connect" class="level2">
<h2 class="anchored" data-anchor-id="select-runtime-and-connect">Select runtime and connect</h2>
<p>On the top right corner of the page, click the drop-down arrow to the right of the <code>Connect</code> button and select <code>Change runtime type</code>.</p>
<p><img src="imgs/connect_runtime.png" class="img-fluid" style="width:50.0%"></p>
<hr>
<p>Make sure <code>Python 3</code> runtime is selected. For this part of the workshop <code>CPU</code> acceleration is enough.</p>
<p><img src="imgs/select_runtime.png" class="img-fluid" style="width:50.0%"></p>
<hr>
<p>Now we can connect to the runtime by clicking <code>Connect</code>. This will create a <strong>V</strong>irtual <strong>M</strong>achine (<strong>VM</strong>) with compute resources we can use for a limited amount of time.</p>
<p><img src="imgs/connect.png" style="height:25.0%"></p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>In free Colab accounts these resources are not guaranteed and can be taken away without notice (preemptible machines).</p>
<p>Data stored in this runtime will be lost if not moved into other storage when the runtime is deleted.</p>
</div>
</div>
</section>
</section>
<section id="what-is-machine-learning-ml" class="level1">
<h1>1. What is <strong>M</strong>achine <strong>L</strong>earning (<strong>ML</strong>)?</h1>
<hr>
<section id="machine-learning-ml" class="level2">
<h2 class="anchored" data-anchor-id="machine-learning-ml"><strong>M</strong>achine <strong>L</strong>earning (<strong>ML</strong>)</h2>
<p>Sub-field of <strong>Artificial Intelligence</strong> that develops methods to address tasks that require human intelligence</p>
<p><img src="imgs/Diagram_AI.png" class="img-fluid" style="width:50.0%"></p>
</section>
<section id="artificial-intelligence-tasks" class="level2">
<h2 class="anchored" data-anchor-id="artificial-intelligence-tasks">Artificial intelligence tasks</h2>
<hr>
</section>
<section id="common-tasks" class="level2">
<h2 class="anchored" data-anchor-id="common-tasks">Common tasks</h2>
<div class="columns">
<div class="column" style="width:30%;">
<p><strong>Classification</strong></p>
<p><img src="imgs/Object.png" class="img-fluid"></p>
<p>what is this?</p>
</div><div class="column" style="width:30%;">
<p><strong>Detection</strong></p>
<p><img src="imgs/Detect.png" class="img-fluid"></p>
<p>where is something?</p>
</div><div class="column" style="width:30%;">
<p><strong>Segmentation</strong></p>
<p><img src="imgs/Segment.png" class="img-fluid"></p>
<p>where <em>specifically</em> is something?</p>
</div>
</div>
<hr>
<section id="more-tasks-addressed-in-recent-years" class="level3">
<h3 class="anchored" data-anchor-id="more-tasks-addressed-in-recent-years">More tasks addressed in recent years</h3>
<ul>
<li><p>Style transference</p></li>
<li><p>Compression of image/video/etc…</p></li>
<li><p>Generation of content</p></li>
<li><p>Language processing</p></li>
</ul>
</section>
</section>
</section>
<section id="types-of-machine-learning" class="level1">
<h1>Types of machine learning</h1>
<hr>
<section id="types-of-machine-learning-1" class="level2">
<h2 class="anchored" data-anchor-id="types-of-machine-learning-1">Types of machine learning</h2>
<section id="depending-on-how-the-model-is-trained" class="level3">
<h3 class="anchored" data-anchor-id="depending-on-how-the-model-is-trained">Depending on how the model is trained</h3>
<ul>
<li><p>Supervised</p></li>
<li><p>Unsupervised</p></li>
<li><p>Weakly supervised</p></li>
<li><p>Reinforced</p></li>
<li><p>…</p></li>
</ul>
<div class="notes">
<p>Supervised learning: teach the machine to perform a task with a set of inputs and their respective expected outcome (<span class="math inline">\(X\)</span>, <span class="math inline">\(Y\)</span>).</p>
<p>Unsupervised learning: let the machine learn to perform a task on its own (<span class="math inline">\(X\)</span>) without any specific expected outcome.</p>
<p>Weakly supervised: teach the machine to perform a task using a limited set of expected outcomes.</p>
<p>Reinforced learning: let the machine learn to perform a task on its own, then give it a reward relative to its performance.</p>
</div>
</section>
</section>
</section>
<section id="inputs-and-outputs" class="level1">
<h1>Inputs and outputs</h1>
<hr>
<section id="inputs-and-outputs-1" class="level2">
<h2 class="anchored" data-anchor-id="inputs-and-outputs-1">Inputs and outputs</h2>
<p>For a task, we want to <em>model</em> the <strong>outcome/output</strong> (<span class="math inline">\(y\)</span>) obtained by a given <strong>input</strong> (<span class="math inline">\(x\)</span>)</p>
<p><span class="math inline">\(f(x) \approx y\)</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The complete set of (<span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>) pairs is known as dataset (<span class="math inline">\(X\)</span>, <span class="math inline">\(Y\)</span>).</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Inputs can be virtually anything, including images, texts, video, audio, electrical signals, etc.</p>
<p>While outputs are expected to be some meaningful piece of information, such as a category, position, value, etc.</p>
</div>
</div>
<hr>
</section>
<section id="use-case-image-classification-with-the-cifar-100-dataset" class="level2">
<h2 class="anchored" data-anchor-id="use-case-image-classification-with-the-cifar-100-dataset">Use case: Image classification with the CIFAR-100 dataset</h2>
<ul class="task-list">
<li><label><input type="checkbox">Load the CIFAR-100 dataset from torchvision.datasets</label></li>
</ul>
<div id="2604515d" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>cifar_ds <span class="op">=</span> torchvision.datasets.CIFAR100(root<span class="op">=</span><span class="st">"/tmp"</span>, train<span class="op">=</span><span class="va">True</span>, download<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Files already downloaded and verified</code></pre>
</div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Explore the CIFAR-100 dataset</label></li>
</ul>
<div id="8c86d998" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x_im, y <span class="op">=</span> cifar_ds[<span class="dv">0</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(cifar_ds), <span class="bu">type</span>(x_im), <span class="bu">type</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>(50000, PIL.Image.Image, int)</code></pre>
</div>
</div>
<div id="b04e443c" class="cell" data-execution_count="5">
<div class="cell-output cell-output-stdout">
<pre><code>y = 19 (cattle)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="introduction-to-pytorch" class="level1">
<h1>Introduction to PyTorch</h1>
<section id="what-is-a-tensor-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-tensor-pytorch">What is a tensor (PyTorch)?</h2>
<p>A tensor is a multi-dimensional array. In PyTorch, this comes from a generalization of the notation of variables that exists on more than two dimensions.</p>
<ul>
<li>zero-dimensional variables are points,</li>
<li>one-dimensional variables are vectors,</li>
<li>two-dimensional variables are matrices,</li>
<li>and three or more dimensional variables, are tensors.</li>
</ul>
<div id="e8fb11ea" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> torch.Tensor([<span class="dv">7</span>]) <span class="co"># This is a point</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> torch.Tensor([<span class="dv">15</span>, <span class="dv">64</span>, <span class="dv">123</span>]) <span class="co"># This is a vector</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> torch.Tensor([[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">5</span>],</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                   [<span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">12</span>],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                   [<span class="dv">10</span>, <span class="dv">33</span>, <span class="dv">1</span>]]) <span class="co"># This is a matrix</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>x3 <span class="op">=</span> torch.Tensor([[[[<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                     [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                     [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>]],</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                    [[<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                     [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                     [<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">5</span>]]]]) <span class="co"># This is a tensor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul class="task-list">
<li><label><input type="checkbox">Convert the example image <code>x_im</code> to a PyTorch tensor, and cast it to floating point data type</label></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can use the utilities in <code>torchvision</code> to convert an image from PIL to tensor</p>
</div>
</div>
<div id="00d36355" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms.v2 <span class="im">import</span> PILToTensor</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>pre_process <span class="op">=</span> PILToTensor()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pre_process(x_im)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x.<span class="bu">float</span>()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x), x.shape, x.dtype, x.<span class="bu">min</span>(), x.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(torch.Tensor,
 torch.Size([3, 32, 32]),
 torch.float32,
 tensor(1.),
 tensor(255.))</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For convenience, PyTorch’s tensors have their channels axis before the spatial axes.</p>
</div>
</div>
<hr>
<ul class="task-list">
<li><label><input type="checkbox">Create a composed transformation to carry out the conversion, casting to float, and rescaling to <span class="math inline">\([0, 1]\)</span> range in the same function.</label></li>
</ul>
<div id="3652c424" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms.v2 <span class="im">import</span> Compose, PILToTensor, ToDtype</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>pre_process <span class="op">=</span> Compose([</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  PILToTensor(),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  ToDtype(torch.float32, scale<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pre_process(x_im)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x), x.shape, x.dtype, x.<span class="bu">min</span>(), x.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>(torch.Tensor,
 torch.Size([3, 32, 32]),
 torch.float32,
 tensor(0.0039),
 tensor(1.))</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For convenience, PyTorch’s tensors have their channels axis before the spatial axes.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-add-the-preprocessing-pipeline-to-the-cifar-100-dataset" class="level2">
<h2 class="anchored" data-anchor-id="exercise-add-the-preprocessing-pipeline-to-the-cifar-100-dataset">Exercise: Add the preprocessing pipeline to the CIFAR-100 dataset</h2>
<ul class="task-list">
<li><label><input type="checkbox">Re-load the CIFAR-100 dataset, this time passing the <code>pre_process</code> function as argument.</label></li>
</ul>
<div id="b81f098d" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cifar_ds <span class="op">=</span> torchvision.datasets.CIFAR100(root<span class="op">=</span><span class="st">"/tmp"</span>, train<span class="op">=</span><span class="va">True</span>, download<span class="op">=</span><span class="va">True</span>, transform<span class="op">=</span>pre_process)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Files already downloaded and verified</code></pre>
</div>
</div>
</section>
</section>
<section id="training-validation-and-test-data" class="level1">
<h1>Training, Validation, and Test data</h1>
<hr>
<section id="training-set" class="level2">
<h2 class="anchored" data-anchor-id="training-set">Training set</h2>
<p>The examples (<span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>) used to teach a machine/model to perform a task</p>
<hr>
</section>
<section id="validation-set" class="level2">
<h2 class="anchored" data-anchor-id="validation-set">Validation set</h2>
<p>Used to measure the performance of a model during training</p>
<p>This subset is not used for training the model, so it is <em>unseen</em> data.</p>
<div class="notes">
<p>This is a subset from the <em>training set</em> and can be used to test the generalization capacity of the model or to select the best configuration of a model.</p>
</div>
<hr>
</section>
<section id="test-set" class="level2">
<h2 class="anchored" data-anchor-id="test-set">Test set</h2>
<p>This set of samples is <strong>not</strong> used when training</p>
<p>Its purpose is to measure the <em>generalization</em> capacity of the model</p>
<hr>
</section>
<section id="exercise-load-the-test-set-and-split-the-train-set-into-train-and-validation-subsets" class="level2">
<h2 class="anchored" data-anchor-id="exercise-load-the-test-set-and-split-the-train-set-into-train-and-validation-subsets">Exercise: Load the test set and split the train set into train and validation subsets</h2>
<ul class="task-list">
<li><label><input type="checkbox">Load the CIFAR-100 test set</label></li>
</ul>
<div id="f39afb60" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cifar_test_ds <span class="op">=</span> torchvision.datasets.CIFAR100(root<span class="op">=</span><span class="st">"/tmp"</span>, train<span class="op">=</span><span class="va">False</span>, download<span class="op">=</span><span class="va">True</span>, transform<span class="op">=</span>pre_process)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Files already downloaded and verified</code></pre>
</div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Split the training set into train and validation subsets</label></li>
</ul>
<div id="97bd22e7" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> random_split</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>cifar_train_ds, cifar_val_ds <span class="op">=</span> random_split(cifar_ds, (<span class="dv">40_000</span>, <span class="dv">10_000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="deep-learning-dl-models" class="level1">
<h1><strong>D</strong>eep <strong>L</strong>earning (<strong>DL</strong>) models</h1>
<hr>
<section id="deep-learning-dl-models-1" class="level2">
<h2 class="anchored" data-anchor-id="deep-learning-dl-models-1">Deep Learning (DL) models</h2>
<p>Models that construct knowledge in a hierarchical manner are considered <strong>deep models</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.mdpi.com/applsci/applsci-09-05507/article_deploy/html/images/applsci-09-05507-g003-550.jpg" style="height:50.0%" class="figure-img"></p>
<figcaption><a href="https://www.mdpi.com/595982">From Cervantes-Sanchez et al.</a></figcaption>
</figure>
</div>
<hr>
</section>
<section id="exercise-create-a-logisic-regression-model-with-pytorch" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-create-a-logisic-regression-model-with-pytorch">Exercise: Create a Logisic Regression model with PyTorch</h2>
<ul class="task-list">
<li><label><input type="checkbox">Use the <code>nn</code> (Neural Networks) module from <code>pytorch</code> to create a Logistic Regression model</label></li>
</ul>
<div id="72fb117d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>lr_clf_1 <span class="op">=</span> nn.Linear(in_features<span class="op">=</span><span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>, out_features<span class="op">=</span><span class="dv">100</span>, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>lr_clf_2 <span class="op">=</span> nn.Softmax()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox"><em>Feed</em> the model with a sample <code>x</code></label></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We have to <em>reshape</em> <code>x</code> before feeding it to the model because <code>x</code> is an image with axes: Channels, Height, Width (CHW), but the Logistic Regression input should be a vector.</p>
</div>
</div>
<div id="560e39fb" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> lr_clf_2( lr_clf_1( x.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>) ))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(y_hat), y_hat.shape, y_hat.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(torch.Tensor, torch.Size([1, 100]), torch.float32)</code></pre>
</div>
</div>
<hr>
</section>
<section id="exercise-create-a-multilayer-perceptron-mlp-model-with-pytorch" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-create-a-multilayer-perceptron-mlp-model-with-pytorch">Exercise: Create a MultiLayer Perceptron (MLP) model with PyTorch</h2>
<ul class="task-list">
<li><label><input type="checkbox">Use the <code>nn.Sequential</code> module to build sequential models</label></li>
</ul>
<div id="075097b0" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mlp_clf <span class="op">=</span> nn.Sequential(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  nn.Linear(in_features<span class="op">=</span><span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>, out_features<span class="op">=</span><span class="dv">1024</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  nn.Tanh(),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  nn.Linear(in_features<span class="op">=</span><span class="dv">1024</span>, out_features<span class="op">=</span><span class="dv">100</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  nn.Softmax()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox"><em>Feed</em> the model with a sample <code>x</code></label></li>
</ul>
<div id="a109acc4" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> mlp_clf(x.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(y_hat), y_hat.shape, y_hat.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(torch.Tensor, torch.Size([1, 100]), torch.float32)</code></pre>
</div>
</div>
</section>
</section>
<section id="model-optimization" class="level1">
<h1>Model optimization</h1>
<hr>
<section id="model-fittingtraining" class="level2">
<h2 class="anchored" data-anchor-id="model-fittingtraining">Model fitting/training</h2>
<p>Models behavior depends directly on the value of their set of parameters <span class="math inline">\(\theta\)</span>.</p>
<ul>
<li><span class="math inline">\(f(x) \approx y\)</span></li>
<li><span class="math inline">\(f_\theta(x) = y + \epsilon = \hat{y}\)</span></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As models increase their number of parameters, they become more <em>complex</em></p>
</div>
</div>
<p><strong>Training</strong> is the process of optimizing the values of <span class="math inline">\(\theta\)</span></p>
<div class="notes">
<p>Training is often an expensive process in terms of computational resources and time.</p>
</div>
</section>
</section>
<section id="loss-function" class="level1">
<h1>Loss function</h1>
<hr>
<section id="loss-function-1" class="level2">
<h2 class="anchored" data-anchor-id="loss-function-1">Loss function</h2>
<p>This is measure of the difference between the expected outputs and the predictions made by a model <span class="math inline">\(L(Y, \hat{Y})\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We look for <em>smooth</em> loss functions for which we can compute their gradient</p>
</div>
</div>
<hr>
</section>
<section id="loss-function-for-regression" class="level2">
<h2 class="anchored" data-anchor-id="loss-function-for-regression">11.1 Loss function for regression</h2>
<p>In the case of regression tasks we generally use the Mean Squared Error (MSE).</p>
<p><span class="math inline">\(MSE=\frac{1}{N}\sum \left(Y - \hat{Y}\right)^2\)</span></p>
<hr>
</section>
<section id="loss-function-for-classification" class="level2">
<h2 class="anchored" data-anchor-id="loss-function-for-classification">Loss function for classification</h2>
<p>And for classification tasks we use the <strong>C</strong>ross <strong>E</strong>ntropy (<strong>CE</strong>) function.</p>
<p><span class="math inline">\(CE = -\frac{1}{N}\sum\limits_i^N\sum\limits_k^C y_{i,k} log(\hat{y_{i,k}})\)</span></p>
<p>where <span class="math inline">\(C\)</span> is the number of classes.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the binary classification case:</p>
<p><span class="math inline">\(BCE = -\frac{1}{N}\sum\limits_i^N \left(y_i log(\hat{y_i}) + (1 - y_i) log(1 - \hat{y_i})\right)\)</span></p>
</div>
</div>
<hr>
</section>
<section id="exercise-define-the-loss-function-for-the-cifar-100-classification-problem" class="level2">
<h2 class="anchored" data-anchor-id="exercise-define-the-loss-function-for-the-cifar-100-classification-problem">Exercise: Define the loss function for the CIFAR-100 classification problem</h2>
<ul class="task-list">
<li><label><input type="checkbox">Define a Cross Entropy loss function with <code>nn.CrossEntropyLoss</code></label></li>
</ul>
<div id="cdae98c7" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>loss_fun <span class="op">=</span> nn.CrossEntropyLoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Remove the <code>nn.Softmax</code> layer from the MLP model.</label></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>According to the PyTorch documentation, the CrossEntropyLoss function takes as inputs the <em>logits</em> of the probabilities and not the probabilities themselves. So, we don’t need to <em>squash</em> the output of the MLP model.</p>
</div>
</div>
<div id="4ffd3959" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mlp_clf <span class="op">=</span> nn.Sequential(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  nn.Linear(in_features<span class="op">=</span><span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>, out_features<span class="op">=</span><span class="dv">1024</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  nn.Tanh(),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  nn.Linear(in_features<span class="op">=</span><span class="dv">1024</span>, out_features<span class="op">=</span><span class="dv">100</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nn.Softmax() # &lt;- remove this line</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="exercise-define-the-loss-function-for-the-cifar-100-classification-problem-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-define-the-loss-function-for-the-cifar-100-classification-problem-1">Exercise: Define the loss function for the CIFAR-100 classification problem</h2>
<ul class="task-list">
<li><label><input type="checkbox">Measure the prediction loss (error) of our MLP with respect to the grund-truth</label></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are using a PyTorch loss function, and it expects PyTorch’s tensors as arguments, so we have to convert <code>y</code> to tensor before computing the loss function.</p>
</div>
</div>
<div id="86b399fc" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> loss_fun(y_hat, torch.LongTensor([y]))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>tensor(4.6077, grad_fn=&lt;NllLossBackward0&gt;)</code></pre>
</div>
</div>
</section>
</section>
<section id="gradient-based-optimization" class="level1">
<h1>Gradient based optimization</h1>
<hr>
<section id="gradient-based-optimization-1" class="level2">
<h2 class="anchored" data-anchor-id="gradient-based-optimization-1">Gradient based optimization</h2>
<p><em>Gradient</em>-based methods are able to fit large numbers of parameters when using a <em>smooth</em> Loss function as target.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We compute the gradient of the loss function with respect to the model parameters using the chain rule from calculous. Generally, this is managed by the machine learning packages such as PyTorch and Tensorflow with a method called <em>back propagation</em>.</p>
</div>
</div>
<section id="gradient-descent" class="level3">
<h3 class="anchored" data-anchor-id="gradient-descent"><strong>Gradient Descent</strong></h3>
<ul>
<li><span class="math inline">\(\theta^{t+1} = \theta^t - \eta \nabla_\theta L(Y, \hat{Y})\)</span></li>
</ul>
<hr>
</section>
</section>
<section id="exercise-compute-the-gradient-of-the-loss-function-with-respect-to-the-parameters-of-the-mlp." class="level2">
<h2 class="anchored" data-anchor-id="exercise-compute-the-gradient-of-the-loss-function-with-respect-to-the-parameters-of-the-mlp.">Exercise: Compute the gradient of the loss function with respect to the parameters of the MLP.</h2>
<ul class="task-list">
<li><label><input type="checkbox">Check what are the gradients of the MLP parameters befor back propagating the gradient.</label></li>
</ul>
<div id="003b6d97" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>mlp_clf[<span class="dv">0</span>].bias.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Compute the gradient of the loss function with respect to the MLP parameters.</label></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To <em>back propagate</em> the gradients we use the <code>loss.backward()</code> method of the loss function.</p>
</div>
</div>
<div id="28d25f76" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> loss_fun(y_hat, torch.LongTensor([y]))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Verify that the gradients have been propagated to the model parameters.</label></li>
</ul>
<div id="4666c0c9" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mlp_clf[<span class="dv">0</span>].bias.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="stochastic-methods" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-methods">Stochastic methods</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Gradient descent method require to obtain the Loss function for the whole training set before doing a single update.</p>
<p>This can be inefficient when large volumes of data are used for training the model.</p>
</div>
</div>
<ul>
<li><p>These methods use a relative small sample from the training data called <em>mini-batch</em> at a time.</p></li>
<li><p>This reduces the amount of memory used for computing intermediate operations carried out during optimization process.</p></li>
</ul>
<hr>
</section>
<section id="stochastic-gradient-descent-sgd" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-gradient-descent-sgd"><strong>S</strong>tochastic <strong>G</strong>radient <strong>D</strong>escent (<strong>SGD</strong>)</h2>
<div class="notes">
<p>This strategy defines <span class="math inline">\(\theta\)</span>’s’ update rule for iteration <span class="math inline">\(t+1\)</span> using a <em>mini-batch</em> sampled at random from the training set as follows.</p>
</div>
<ul>
<li><p><span class="math inline">\(\theta^{t+1} = \theta^t - \eta \nabla_\theta L(Y_{b}, \hat{Y_{b}})\)</span></p></li>
<li><p><span class="math inline">\(\eta\)</span> controls the update we perform on the current parameter’s values</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This parameter in Deep Learning is known as the <strong>learning rate</strong></p>
</div>
</div>
<hr>
</section>
<section id="training-with-mini-batches" class="level2">
<h2 class="anchored" data-anchor-id="training-with-mini-batches">Training with mini-batches</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>PyTorch can operate efficiently on multiple inputs at the same time. To do that, we can use a <code>DataLoader</code> to serve mini-batches of inputs.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier" class="level2">
<h2 class="anchored" data-anchor-id="exercise-train-the-mlp-classifier">Exercise: Train the MLP classifier</h2>
<ul class="task-list">
<li><label><input type="checkbox">Use a <code>DataLoader</code> to serve mini-batches of images to train our MLP.</label></li>
</ul>
<div id="78463b4e" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>cifar_train_dl <span class="op">=</span> DataLoader(cifar_train_ds, batch_size<span class="op">=</span><span class="dv">128</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>cifar_val_dl <span class="op">=</span> DataLoader(cifar_val_ds, batch_size<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>cifar_test_dl <span class="op">=</span> DataLoader(cifar_test_ds, batch_size<span class="op">=</span><span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><label><input type="checkbox">Create a Stochastic Gradient Descent optimizer for our MLP classifier.</label></li>
</ul>
<div id="ab186d28" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.SGD(mlp_clf.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>, )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier-1" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-train-the-mlp-classifier-1">Exercise: Train the MLP classifier</h2>
<ul class="task-list">
<li><label><input type="checkbox">Implement the <em>training-loop</em> to fit the parameters of our MLP classifier.</label></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Gradients are accumulated on every iteration, so we need to reset the accumulator with <code>optimizer.zero_grad()</code> for every new batch.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To perform get the new iteration’s parameter values <span class="math inline">\(\theta^{t+1}\)</span> we use <code>optimizer.step()</code> to compute the update step.</p>
</div>
</div>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a>mlp_clf.train()</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="cf">for</span> x, y <span class="kw">in</span> cifar_train_dl:</span>
<span id="cb31-3"><a href="#cb31-3"></a>  optimizer.zero_grad()</span>
<span id="cb31-4"><a href="#cb31-4"></a></span>
<span id="cb31-5"><a href="#cb31-5"></a>  y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) ) <span class="co"># Reshape it into a batch of vectors</span></span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a>  loss <span class="op">=</span> loss_fun(y_hat, y)</span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a>  loss.backward()</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>  optimizer.step()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss" class="level2">
<h2 class="anchored" data-anchor-id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss">Exercise: Train the MLP classifier and track the training and validation loss</h2>
<ul class="task-list">
<li><label><input type="checkbox">Save the loss function of each batch and the overall average loss during training.</label></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To extract the loss function’s value without anything else attached use <code>loss.item()</code>.</p>
</div>
</div>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a>train_loss <span class="op">=</span> []</span>
<span id="cb32-2"><a href="#cb32-2"></a>train_loss_avg <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>total_train_samples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-4"><a href="#cb32-4"></a></span>
<span id="cb32-5"><a href="#cb32-5"></a>mlp_clf.train()</span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="cf">for</span> x, y <span class="kw">in</span> cifar_train_dl:</span>
<span id="cb32-7"><a href="#cb32-7"></a>  optimizer.zero_grad()</span>
<span id="cb32-8"><a href="#cb32-8"></a></span>
<span id="cb32-9"><a href="#cb32-9"></a>  y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) ) <span class="co"># Reshape it into a batch of vectors</span></span>
<span id="cb32-10"><a href="#cb32-10"></a></span>
<span id="cb32-11"><a href="#cb32-11"></a>  loss <span class="op">=</span> loss_fun(y_hat, y)</span>
<span id="cb32-12"><a href="#cb32-12"></a></span>
<span id="cb32-13"><a href="#cb32-13"></a>  train_loss.append(loss.item())</span>
<span id="cb32-14"><a href="#cb32-14"></a>  train_loss_avg <span class="op">+=</span> loss.item() <span class="op">*</span> <span class="bu">len</span>(x)</span>
<span id="cb32-15"><a href="#cb32-15"></a>  total_train_samples <span class="op">+=</span> <span class="bu">len</span>(x)</span>
<span id="cb32-16"><a href="#cb32-16"></a></span>
<span id="cb32-17"><a href="#cb32-17"></a>  loss.backward()</span>
<span id="cb32-18"><a href="#cb32-18"></a></span>
<span id="cb32-19"><a href="#cb32-19"></a>  optimizer.step()</span>
<span id="cb32-20"><a href="#cb32-20"></a></span>
<span id="cb32-21"><a href="#cb32-21"></a>train_loss_avg <span class="op">/=</span> total_train_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-1">Exercise: Train the MLP classifier and track the training and validation loss</h2>
<ul class="task-list">
<li><label><input type="checkbox">Compute the average loss function for the validation set.</label></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because we don’t train the model with the validation set, back-propagation and optimization steps are not needed.</p>
<p>Additionally, we wrap the loop <code>with torch.no_grad()</code> to prevent the generation of gradients that could fill the memory innecessarily.</p>
</div>
</div>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>val_loss_avg <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>total_val_samples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-3"><a href="#cb33-3"></a></span>
<span id="cb33-4"><a href="#cb33-4"></a>mlp_clf.<span class="bu">eval</span>()</span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="cf">for</span> x, y <span class="kw">in</span> cifar_val_dl:</span>
<span id="cb33-7"><a href="#cb33-7"></a>    y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) ) <span class="co"># Reshape it into a batch of vectors</span></span>
<span id="cb33-8"><a href="#cb33-8"></a>    loss <span class="op">=</span> loss_fun(y_hat, y)</span>
<span id="cb33-9"><a href="#cb33-9"></a></span>
<span id="cb33-10"><a href="#cb33-10"></a>    val_loss_avg <span class="op">+=</span> loss.item() <span class="op">*</span> <span class="bu">len</span>(x)</span>
<span id="cb33-11"><a href="#cb33-11"></a>    total_val_samples <span class="op">+=</span> <span class="bu">len</span>(x)</span>
<span id="cb33-12"><a href="#cb33-12"></a></span>
<span id="cb33-13"><a href="#cb33-13"></a>val_loss_avg <span class="op">/=</span> total_val_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-2" class="level2">
<h2 class="anchored" data-anchor-id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-2">Exercise: Train the MLP classifier and track the training and validation loss</h2>
<ul class="task-list">
<li><label><input type="checkbox">Plot the training loss for this <em>epoch</em>.</label></li>
</ul>
<div id="fc393394" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>plt.plot(train_loss, <span class="st">"b-"</span>, label<span class="op">=</span><span class="st">"Training loss"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="bu">len</span>(train_loss)], [train_loss_avg, train_loss_avg], <span class="st">"r:"</span>, label<span class="op">=</span><span class="st">"Average training loss"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="bu">len</span>(train_loss)], [val_loss_avg, val_loss_avg], <span class="st">"b:"</span>, label<span class="op">=</span><span class="st">"Average validation loss"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-27-output-1.png" width="579" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-through-several-epochs" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-train-the-mlp-classifier-and-track-the-training-and-validation-loss-through-several-epochs">Exercise: Train the MLP classifier and track the training and validation loss through several <em>epochs</em></h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a>num_epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>train_loss <span class="op">=</span> []</span>
<span id="cb35-3"><a href="#cb35-3"></a>val_loss <span class="op">=</span> []</span>
<span id="cb35-4"><a href="#cb35-4"></a></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="cf">for</span> e <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb35-6"><a href="#cb35-6"></a>  train_loss_avg <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-7"><a href="#cb35-7"></a>  total_train_samples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-8"><a href="#cb35-8"></a></span>
<span id="cb35-9"><a href="#cb35-9"></a>  mlp_clf.train()</span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="cf">for</span> x, y <span class="kw">in</span> cifar_train_dl:</span>
<span id="cb35-11"><a href="#cb35-11"></a>    optimizer.zero_grad()</span>
<span id="cb35-12"><a href="#cb35-12"></a></span>
<span id="cb35-13"><a href="#cb35-13"></a>    y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) ) <span class="co"># Reshape it into a batch of vectors</span></span>
<span id="cb35-14"><a href="#cb35-14"></a></span>
<span id="cb35-15"><a href="#cb35-15"></a>    loss <span class="op">=</span> loss_fun(y_hat, y)</span>
<span id="cb35-16"><a href="#cb35-16"></a></span>
<span id="cb35-17"><a href="#cb35-17"></a>    train_loss_avg <span class="op">+=</span> loss.item() <span class="op">*</span> <span class="bu">len</span>(x)</span>
<span id="cb35-18"><a href="#cb35-18"></a>    total_train_samples <span class="op">+=</span> <span class="bu">len</span>(x)</span>
<span id="cb35-19"><a href="#cb35-19"></a></span>
<span id="cb35-20"><a href="#cb35-20"></a>    loss.backward()</span>
<span id="cb35-21"><a href="#cb35-21"></a></span>
<span id="cb35-22"><a href="#cb35-22"></a>    optimizer.step()</span>
<span id="cb35-23"><a href="#cb35-23"></a></span>
<span id="cb35-24"><a href="#cb35-24"></a>  train_loss_avg <span class="op">/=</span> total_train_samples</span>
<span id="cb35-25"><a href="#cb35-25"></a>  train_loss.append(train_loss_avg)</span>
<span id="cb35-26"><a href="#cb35-26"></a></span>
<span id="cb35-27"><a href="#cb35-27"></a>  val_loss_avg <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-28"><a href="#cb35-28"></a>  total_val_samples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-29"><a href="#cb35-29"></a></span>
<span id="cb35-30"><a href="#cb35-30"></a>  mlp_clf.<span class="bu">eval</span>()</span>
<span id="cb35-31"><a href="#cb35-31"></a>  <span class="cf">with</span> torch.no_grad():</span>
<span id="cb35-32"><a href="#cb35-32"></a>    <span class="cf">for</span> x, y <span class="kw">in</span> cifar_val_dl:</span>
<span id="cb35-33"><a href="#cb35-33"></a>      y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) ) <span class="co"># Reshape it into a batch of vectors</span></span>
<span id="cb35-34"><a href="#cb35-34"></a>      loss <span class="op">=</span> loss_fun(y_hat, y)</span>
<span id="cb35-35"><a href="#cb35-35"></a></span>
<span id="cb35-36"><a href="#cb35-36"></a>      val_loss_avg <span class="op">+=</span> loss.item() <span class="op">*</span> <span class="bu">len</span>(x)</span>
<span id="cb35-37"><a href="#cb35-37"></a>      total_val_samples <span class="op">+=</span> <span class="bu">len</span>(x)</span>
<span id="cb35-38"><a href="#cb35-38"></a></span>
<span id="cb35-39"><a href="#cb35-39"></a>  val_loss_avg <span class="op">/=</span> total_val_samples</span>
<span id="cb35-40"><a href="#cb35-40"></a>  val_loss.append(val_loss_avg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="exercise-show-the-progress-of-the-training-throught-the-epochs" class="level2">
<h2 class="anchored" data-anchor-id="exercise-show-the-progress-of-the-training-throught-the-epochs">Exercise: Show the progress of the training throught the epochs</h2>
<ul class="task-list">
<li><label><input type="checkbox">Plot the average train and validation losses</label></li>
</ul>
<div id="e6e47f8a" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>plt.plot(train_loss, <span class="st">"b-"</span>, label<span class="op">=</span><span class="st">"Average training loss"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>plt.plot(val_loss, <span class="st">"r-"</span>, label<span class="op">=</span><span class="st">"Average validation loss"</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-29-output-1.png" width="579" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="performance-metrics" class="level1">
<h1>Performance metrics</h1>
<hr>
<section id="performance-metrics-1" class="level2">
<h2 class="anchored" data-anchor-id="performance-metrics-1">Performance metrics</h2>
<p>Used to measure how good or bad a model carries out a task</p>
<ul>
<li><p><span class="math inline">\(f(x) \approx y\)</span></p></li>
<li><p><span class="math inline">\(f(x) = y + \epsilon = \hat{y}\)</span></p></li>
</ul>
<div class="notes">
<p>Given the set of parameters, as well as other factors, the output of a model can deviate from the expected outcome. So, the actual output of a model is <span class="math inline">\(f(x) = \hat{y}\)</span>.</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The output <span class="math inline">\(\hat{y}\)</span> is called <strong>prediction </strong> given the context taken from statistical regression analysis.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Selecting the correct performance metrics depends on the training type, task, and even the distribution of the data.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100">Exercise: Measure the accuracy of the MLP trained to classify images from CIFAR-100</h2>
<ul class="task-list">
<li><label><input type="checkbox">Install the <code>torchmetrics</code> package.</label></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install torchmetrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul class="task-list">
<li><label><input type="checkbox">Compute the average accuracy for the Train set.</label></li>
</ul>
<div id="7bd1fc3d" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchmetrics.classification <span class="im">import</span> Accuracy</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>mlp_clf.<span class="bu">eval</span>()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>train_acc_metric <span class="op">=</span> Accuracy(task<span class="op">=</span><span class="st">"multiclass"</span>, num_classes<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x, y <span class="kw">in</span> cifar_train_dl:</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) )</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    train_acc_metric(y_hat.softmax(dim<span class="op">=</span><span class="dv">1</span>), y)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  train_acc <span class="op">=</span> train_acc_metric.compute()</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training acc=</span><span class="sc">{</span>train_acc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>train_acc_metric.reset()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training acc=0.106174997985363</code></pre>
</div>
</div>
<hr>
</section>
<section id="exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100-1" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="exercise-measure-the-accuracy-of-the-mlp-trained-to-classify-images-from-cifar-100-1">Exercise: Measure the accuracy of the MLP trained to classify images from CIFAR-100</h2>
<ul class="task-list">
<li><label><input type="checkbox">Compute the average accuracy for the Validation and Test sets.</label></li>
</ul>
<div id="fbb70e96" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>val_acc_metric <span class="op">=</span> Accuracy(task<span class="op">=</span><span class="st">"multiclass"</span>, num_classes<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>test_acc_metric <span class="op">=</span> Accuracy(task<span class="op">=</span><span class="st">"multiclass"</span>, num_classes<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x, y <span class="kw">in</span> cifar_val_dl:</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) )</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    val_acc_metric(y_hat.softmax(dim<span class="op">=</span><span class="dv">1</span>), y)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  val_acc <span class="op">=</span> val_acc_metric.compute()</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x, y <span class="kw">in</span> cifar_test_dl:</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    y_hat <span class="op">=</span> mlp_clf( x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">32</span>) )</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    test_acc_metric(y_hat.softmax(dim<span class="op">=</span><span class="dv">1</span>), y)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  test_acc <span class="op">=</span> test_acc_metric.compute()</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Validation acc=</span><span class="sc">{</span>val_acc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test acc=</span><span class="sc">{</span>test_acc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>val_acc_metric.reset()</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>test_acc_metric.reset()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Validation acc=0.09650000184774399
Test acc=0.10100000351667404</code></pre>
</div>
</div>
</section>
</section>
<section id="convolutional-neural-network-cnn-or-convnet" class="level1">
<h1><strong>C</strong>onvolutional <strong>N</strong>eural <strong>N</strong>etwork (<strong>CNN</strong> or <strong>ConvNet</strong>)</h1>
<hr>
<section id="convolution-layers" class="level2">
<h2 class="anchored" data-anchor-id="convolution-layers">Convolution layers</h2>
<p>The most common operation in DL models for image processing are Convolution operations.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://upload.wikimedia.org/wikipedia/commons/8/85/Convolution_arithmetic_-_Full_padding_no_strides_transposed.gif" class="img-fluid figure-img"></p>
<figcaption>2D Convolution</figcaption>
</figure>
</div>
<p>The animation shows the convolution of a 7x7 pixels input image (bottom) with a 3x3 pixels kernel (moving window), that results in a 5x5 pixels output (top).</p>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Create a convolution layer with <code>nn.Conv2D</code> using 3 channels as input, and a single one for output.</label></li>
</ul>
<div id="1cb72280" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>conv_1 <span class="op">=</span> nn.Conv2d(in_channels<span class="op">=</span><span class="dv">3</span>, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">7</span>, padding<span class="op">=</span><span class="dv">0</span>, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>x, _ <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(cifar_train_dl))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>fx <span class="op">=</span> conv_1(x)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(fx), fx.dtype, fx.shape, fx.<span class="bu">min</span>(), fx.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>(torch.Tensor,
 torch.float32,
 torch.Size([128, 1, 26, 26]),
 tensor(-0.4548, grad_fn=&lt;MinBackward1&gt;),
 tensor(0.4700, grad_fn=&lt;MaxBackward1&gt;))</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The convolution layer is initialized with random values, so the results will vary.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-1">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Create a convolution layer with <code>nn.Conv2D</code> using 3 channels as input, and a single one for output.</label></li>
</ul>
<div id="bbeb3885" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">5</span>]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].imshow(x[<span class="dv">0</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].imshow(fx.detach()[<span class="dv">0</span>, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-33-output-1.png" width="418" height="213" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>By default, outputs from PyTorch modules are tracked for back-propagation.</p>
<p>To visualize it with <code>matplotlib</code> we have to <code>.detach()</code> the tensor first.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-2" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-2">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Visualize the weights of the convolution layer.</label></li>
</ul>
<div id="2786fc0d" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>conv_1.weight.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>torch.Size([1, 3, 7, 7])</code></pre>
</div>
</div>
<div id="93e64210" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].imshow(conv_1.weight.detach()[<span class="dv">0</span>, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].imshow(conv_1.weight.detach()[<span class="dv">0</span>, <span class="dv">1</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].imshow(conv_1.weight.detach()[<span class="dv">0</span>, <span class="dv">2</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_axis_off()</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-35-output-1.png" width="408" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-3" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-3">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Modify the weights of the convolution layer.</label></li>
</ul>
<div id="52380f69" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>conv_1 <span class="op">=</span> nn.Conv2d(in_channels<span class="op">=</span><span class="dv">3</span>, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">0</span>, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>conv_1.weight.data[:] <span class="op">=</span> torch.FloatTensor([</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  [</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-4" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-4">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Visualize the effects after changingthe values.</label></li>
</ul>
<div id="ddb8817d" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fx <span class="op">=</span> conv_1(x)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].imshow(x[<span class="dv">0</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].imshow(fx.detach()[<span class="dv">0</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-37-output-1.png" width="418" height="213" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Experiment with different values and shapes of the kernel https://en.wikipedia.org/wiki/Kernel_(image_processing)</p>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-5" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-5">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Modify the weights of the convolution layer.</label></li>
</ul>
<div id="6a2bd99a" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>conv_1 <span class="op">=</span> nn.Conv2d(in_channels<span class="op">=</span><span class="dv">3</span>, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">0</span>, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>conv_1.weight.data[:] <span class="op">=</span> torch.FloatTensor([</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  [[[<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>], [<span class="op">-</span><span class="dv">1</span>, <span class="dv">5</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>]],</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>   [[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]],</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>   [[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]]]</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>fx <span class="op">=</span> conv_1(x)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].imshow(x[<span class="dv">0</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].imshow(fx.detach()[<span class="dv">0</span>, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-38-output-1.png" width="418" height="213" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Experiment with different values and shapes of the kernel https://en.wikipedia.org/wiki/Kernel_(image_processing)</p>
<hr>
</section>
<section id="exercise-visualize-the-effect-of-the-convolution-operation-6" class="level2">
<h2 class="anchored" data-anchor-id="exercise-visualize-the-effect-of-the-convolution-operation-6">Exercise: Visualize the effect of the convolution operation</h2>
<ul class="task-list">
<li><label><input type="checkbox">Modify the weights of the convolution layer.</label></li>
</ul>
<div id="0467bc98" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>conv_1 <span class="op">=</span> nn.Conv2d(in_channels<span class="op">=</span><span class="dv">3</span>, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">0</span>, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>conv_1.weight.data[:] <span class="op">=</span> torch.FloatTensor([</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  [[[<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>   [[<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>   [[<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>]]]</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>fx <span class="op">=</span> conv_1(x)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].imshow(x[<span class="dv">0</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].imshow(fx.detach()[<span class="dv">0</span>, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DL_image_analysis_1_1_files/figure-html/cell-39-output-1.png" width="418" height="213" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Experiment with different values and shapes of the kernel https://en.wikipedia.org/wiki/Kernel_(image_processing)</p>
<hr>
</section>
<section id="examples-of-popular-deep-learning-models-in-computer-vision" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-popular-deep-learning-models-in-computer-vision">Examples of popular Deep Learning models in computer vision</h2>
<ul>
<li>Inception v3 for image classification</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cloud.google.com/static/tpu/docs/images/inceptionv3onc--oview.png" class="img-fluid figure-img"></p>
<figcaption>InceptionV3</figcaption>
</figure>
</div>
<hr>
</section>
<section id="examples-of-popular-deep-learning-models-in-computer-vision-1" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-popular-deep-learning-models-in-computer-vision-1">Examples of popular Deep Learning models in computer vision</h2>
<ul>
<li>U-Net for cell segmentation</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lmb.informatik.uni-freiburg.de/people/ronneber/u-net/u-net-architecture.png" class="img-fluid figure-img"></p>
<figcaption>U-Net</figcaption>
</figure>
</div>
<hr>
</section>
<section id="examples-of-popular-deep-learning-models-in-computer-vision-2" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-popular-deep-learning-models-in-computer-vision-2">Examples of popular Deep Learning models in computer vision</h2>
<ul>
<li>LeNet-5 for handwritten digits classification (<a href="http://yann.lecun.com/exdb/publis/pdf/lecun-01a.pdf">LeCun et al.</a>)</li>
</ul>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/6/61/LeNet_architecture.png" class="img-fluid" alt="LeNet-5"> By Daniel Voigt Godoy - <a rel="nofollow" class="external free" href="https://github.com/dvgodoy/dl-visuals/">https://github.com/dvgodoy/dl-visuals/</a>, <a href="https://creativecommons.org/licenses/by/4.0" title="Creative Commons Attribution 4.0">CC BY 4.0</a>, <a href="https://commons.wikimedia.org/w/index.php?curid=150820922">Link</a></p>
<hr>
</section>
<section id="exercise-implement-letnet-5-in-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="exercise-implement-letnet-5-in-pytorch">Exercise: Implement LetNet-5 in PyTorch</h2>
<ul class="task-list">
<li><label><input type="checkbox">Build the convolutional neural network using <code>nn.Sequential</code>, and the <code>nn.ReLU()</code> activation function.</label></li>
</ul>
<div id="3cf48dc1" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>lenet_clf <span class="op">=</span> nn.Sequential(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    nn.Conv2d(in_channels<span class="op">=</span><span class="dv">3</span>, out_channels<span class="op">=</span><span class="dv">6</span>, kernel_size<span class="op">=</span><span class="dv">5</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    nn.Conv2d(in_channels<span class="op">=</span><span class="dv">6</span>, out_channels<span class="op">=</span><span class="dv">16</span>, kernel_size<span class="op">=</span><span class="dv">5</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    nn.Flatten(),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    nn.Linear(in_features<span class="op">=</span><span class="dv">16</span><span class="op">*</span><span class="dv">5</span><span class="op">*</span><span class="dv">5</span>, out_features<span class="op">=</span><span class="dv">120</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    nn.Linear(in_features<span class="op">=</span><span class="dv">120</span>, out_features<span class="op">=</span><span class="dv">84</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    nn.Linear(in_features<span class="op">=</span><span class="dv">84</span>, out_features<span class="op">=</span><span class="dv">100</span>, bias<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pooling layers are used to downsample feature maps to summarize information from large regions.</p>
</div>
</div>
<hr>
</section>
<section id="exercise-implement-letnet-5-in-pytorch-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-implement-letnet-5-in-pytorch-1">Exercise: Implement LetNet-5 in PyTorch</h2>
<ul class="task-list">
<li><label><input type="checkbox">Test our implementation.</label></li>
</ul>
<div id="8a058c26" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> lenet_clf(x)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(y_hat), y_hat.dtype, y_hat.shape, y_hat.<span class="bu">min</span>(), y_hat.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>(torch.Tensor,
 torch.float32,
 torch.Size([128, 100]),
 tensor(-0.1326, grad_fn=&lt;MinBackward1&gt;),
 tensor(0.1386, grad_fn=&lt;MaxBackward1&gt;))</code></pre>
</div>
</div>
<hr>
</section>
<section id="exercise-implement-letnet-5-in-pytorch-2" class="level2">
<h2 class="anchored" data-anchor-id="exercise-implement-letnet-5-in-pytorch-2">Exercise: Implement LetNet-5 in PyTorch</h2>
<ul class="task-list">
<li><label><input type="checkbox">Train the model to classify images from CIFAR-100.</label></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>